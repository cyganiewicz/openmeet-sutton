<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Meeting</title><link rel="stylesheet" href="./assets/theme.css">
</head><body><div class="wrap">
  <a class="btn" href="./">← All meetings</a>
  <div id="meta" class="card"></div>
  <div class="card" id="oml"></div>
  <div style="display:flex;gap:8px;align-items:center">
    <h3 style="margin:12px 0">Documents</h3>
    <label class="badge"><input id="history" type="checkbox" style="vertical-align:middle;margin-right:6px"> Show history</label>
  </div>
  <div id="files"></div>
</div>
<script type="module">
  import {API, getMeeting, listFiles} from './js/api.js';
  const id = new URLSearchParams(location.search).get('id');
  const m = await getMeeting(id);

  // meta
  const meta=document.getElementById('meta');
  meta.innerHTML=`
    <div style="opacity:.8">${m.board_name}</div>
    <div style="font-size:20px;margin:6px 0"><strong>${m.date}</strong> — ${m.title||''}</div>
    <div>${m.location||''}</div>
    ${m.youtube_url ? `<div style="margin-top:12px"><iframe width="100%" height="360" src="${m.youtube_url.replace('watch?v=','embed/')}" frameborder="0" allowfullscreen></iframe></div>`:''}
    <div style="margin-top:8px;opacity:.8">Status: ${m.status}${m.posted_at?` • Posted at ${m.posted_at}`:''}</div>
  `;

  // 48-hour OML indicator (excludes Sat/Sun)
  function addBusinessHours(startISO, hours=48){
    if(!startISO) return {deadline:null, ok:false, msg:'Not yet posted'};
    const start=new Date(startISO); let remain=hours, d=new Date(start);
    while(remain>0){
      d.setHours(d.getHours()+1);
      const day=d.getDay(); // 0 Sun, 6 Sat
      if(day!==0 && day!==6) remain--;
    }
    return {deadline:d};
  }
  function fmt(d){ return d? new Date(d).toLocaleString() : 'N/A'; }
  const meetingStart = new Date(`${m.date}T${(m.start_time||'00:00')}`);
  const omlBox = document.getElementById('oml');
  if (m.posted_at){
    const {deadline} = addBusinessHours(m.posted_at, 48);
    const ok = deadline <= meetingStart;
    omlBox.innerHTML = `
      <b>Open Meeting Law 48-hour posting window</b>
      <div style="margin-top:6px">
        Posted at: <span>${fmt(m.posted_at)}</span> • Deadline: <span>${fmt(deadline)}</span>
        <span class="badge ${ok?'':'warn'}">${ ok ? 'Compliant' : '⚠️ Past deadline' }</span>
      </div>`;
  } else {
    omlBox.innerHTML = `<b>Open Meeting Law 48-hour posting window</b><div style="margin-top:6px">Agenda not yet posted.</div>`;
  }

  // files + history
  const filesDiv=document.getElementById('files');
  async function renderFiles(){
    filesDiv.innerHTML='';
    const all=document.getElementById('history').checked;
    const files = await listFiles(id, all);
    for(const x of files){
      const row=document.createElement('div'); row.className='card';
      row.innerHTML = `
        <div><a class="pill" href="${x.url}" target="_blank">${x.label||x.type}</a></div>
        ${x.change_log? `<div style="opacity:.8;margin-top:6px">${x.change_log}</div>`:''}`;
      filesDiv.appendChild(row);
    }
  }
  history.onchange = renderFiles;
  renderFiles();
</script>
</body></html>
