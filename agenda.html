<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Agenda Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
</head>
<body>
<div class="wrap">
  <a class="btn" href="./">← Home</a>
  <h2>Agenda Builder</h2>

  <!-- Step 1: Board + meeting basics -->
  <div class="card">
    <h3>1) Board / Meeting Details</h3>
    <label>Board / Committee</label>
    <select id="board"></select>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
      <div><label>Date (YYYY-MM-DD)</label><input id="date" placeholder="2025-09-16"></div>
      <div><label>Start Time (HH:MM)</label><input id="time" placeholder="18:00"></div>
    </div>
    <label>Title</label><input id="title" placeholder="Regular Meeting">
    <label>Location</label><input id="location" placeholder="Town Hall, Room 1A">
    <div class="muted" style="margin-top:6px">Tip: You can still upload packet items later from “Your Meetings”.</div>
  </div>

  <!-- Step 2: Optional remote access blurb (Zoom etc.) -->
  <div class="card">
    <h3>2) Remote Access (optional)</h3>
    <label>Zoom / Remote URL</label><input id="remote_url" placeholder="https://zoom.us/join">
    <label>Phone</label><input id="remote_phone" placeholder="#1-929-205-6099 US (New York)">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div><label>Meeting ID</label><input id="remote_id" placeholder="839 8717 1011"></div>
      <div><label>Passcode</label><input id="remote_pass" placeholder="826597"></div>
    </div>
    <div class="muted" style="margin-top:6px">Leave blank if fully in-person.</div>
  </div>

  <!-- Step 3: Agenda items -->
  <div class="card">
    <h3>3) Agenda Items</h3>
    <div id="items"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="add">Add item</button>
      <button class="btn" id="clear">Clear all</button>
    </div>
    <label style="margin-top:10px">Footer note (optional)</label>
    <input id="footer" placeholder="e.g., Posted per OML within 48 hours.">
  </div>

  <!-- Step 4: Submit -->
  <div class="card">
    <h3>4) Submit to Clerk</h3>
    <label>Your email (for confirmation)</label><input id="email" placeholder="you@example.com">
    <button class="btn" id="submit">Create meeting & send agenda to Clerk</button>
    <div id="out" class="muted" style="margin-top:8px"></div>
  </div>
</div>

<script type="module">
  import { WEBAPP_URL } from './js/auth.js';

  async function j(u){ const r=await fetch(u); if(!r.ok) throw new Error('Failed '+r.status); return r.json(); }
  async function post(body){
    const r = await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
    const t = await r.text(); let out; try{ out=JSON.parse(t);}catch{ throw new Error('Bad JSON: '+t.slice(0,200)); }
    if (out.error) throw new Error(out.error); return out;
  }

  // Load boards for dropdown
  const boardSel = document.getElementById('board');
  try {
    const boards = await j(`${WEBAPP_URL}?route=api/ui/boards`);
    boardSel.innerHTML = (boards && boards.length)
      ? '<option value="">Select a board/committee…</option>' +
        boards.map(b=>`<option value="${b.board_id}">${b.name}</option>`).join('')
      : '<option value="">No boards found</option>';
  } catch {
    boardSel.innerHTML = '<option value="">Could not load boards</option>';
  }

  // Item state + renderer
  const itemsRoot = document.getElementById('items');
  const state = { items: [] };

  function renderItems(){
    itemsRoot.innerHTML='';
    state.items.forEach((it, idx)=>{
      const row = document.createElement('div'); row.className='card';
      row.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
          <div>
            <label>Title</label>
            <input data-k="title" data-i="${idx}" value="${it.title||''}" placeholder="e.g., Approval of Minutes">
            <label>Notes (optional)</label>
            <input data-k="notes" data-i="${idx}" value="${it.notes||''}" placeholder="e.g., Minutes of Sep 2, 2025">
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="btn" data-act="up" data-i="${idx}">↑</button>
            <button class="btn" data-act="down" data-i="${idx}">↓</button>
            <button class="btn" data-act="del" data-i="${idx}">✕</button>
          </div>
        </div>`;
      itemsRoot.appendChild(row);
    });
    itemsRoot.querySelectorAll('input').forEach(inp=>{
      inp.oninput = (e)=>{ const i=Number(e.target.dataset.i), k=e.target.dataset.k; state.items[i][k]=e.target.value; };
    });
    itemsRoot.querySelectorAll('button').forEach(btn=>{
      btn.onclick = (e)=>{
        const i=Number(e.target.dataset.i), act=e.target.dataset.act;
        if (act==='up' && i>0){ const t=state.items[i-1]; state.items[i-1]=state.items[i]; state.items[i]=t; renderItems(); }
        if (act==='down' && i<state.items.length-1){ const t=state.items[i+1]; state.items[i+1]=state.items[i]; state.items[i]=t; renderItems(); }
        if (act==='del'){ state.items.splice(i,1); renderItems(); }
      };
    });
  }
  document.getElementById('add').onclick = ()=>{ state.items.push({title:'',notes:''}); renderItems(); };
  document.getElementById('clear').onclick = ()=>{ if(confirm('Clear all items?')){ state.items=[]; renderItems(); } };
  renderItems();

  // Submit flow: create meeting → generate agenda PDF to Clerk queue
  const out = document.getElementById('out');
  document.getElementById('submit').onclick = async ()=>{
    const board_id = boardSel.value;
    const date = document.getElementById('date').value.trim();
    const start_time = document.getElementById('time').value.trim();
    const title = document.getElementById('title').value.trim() || 'Regular Meeting';
    const location = document.getElementById('location').value.trim();
    const submitterEmail = document.getElementById('email').value.trim();

    if (!board_id) return alert('Choose a board');
    if (!date) return alert('Enter a date');
    if (state.items.length === 0) return alert('Add at least one agenda item');

    try {
      // 1) Create the meeting shell
      const created = await post({ action:'create_meeting_open', board_id, date, start_time, title, location, submitterEmail });

      // 2) Build agenda PDF into Drafts for Clerk approval
      const payload = {
        action:'create_agenda_from_form',
        meeting_id: created.meeting_id,
        items: state.items,
        footerNote: document.getElementById('footer').value,
        submitterEmail,
        // optional remote access block
        remote: {
          url: document.getElementById('remote_url').value,
          phone: document.getElementById('remote_phone').value,
          id: document.getElementById('remote_id').value,
          pass: document.getElementById('remote_pass').value
        }
      };
      await post(payload);

      out.textContent = 'Agenda submitted to Clerk. You’ll get a confirmation email.';
      alert('Agenda sent to Clerk for approval/posting.');
      state.items=[]; renderItems();
    } catch (e) {
      alert(e.message);
    }
  };
</script>
</body>
</html>
