<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Clerk Inbox</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
    .inbox{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff}
    .row{display:grid;grid-template-columns:36px 1.3fr 1fr 1fr auto;gap:12px;align-items:center;border-bottom:1px dashed #eaecef;padding:10px 12px}
    .row:last-child{border-bottom:0}
    .who{font-weight:600}
    .meta{color:#475569}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#f8fafc;font-size:12px;margin-right:6px}
    .pill{padding:4px 8px;border-radius:999px;background:#0f172a;color:#fff;font-size:12px}
    dialog{max-width:760px;width:96%;border:0;border-radius:12px;padding:0;overflow:hidden}
    .dlg-head{background:#0f172a;color:#fff;padding:12px 16px}
    .dlg-body{padding:16px}
    .item{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;margin:6px 0}
    .muted{opacity:.75}
  </style>
  <script type="module">
    import * as Auth from './js/auth.js?v=3.0.2';
    import { mountTopnav } from './js/topnav.js?v=4';

    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const WEBAPP_URL = Auth.WEBAPP_URL;
    let IDT = null, CACHE = {pending:[], meetingsById:{}};

    async function jget(u){ const r=await fetch(u); const t=await r.text(); let j; try{ j=JSON.parse(t);}catch{throw new Error('Bad JSON: '+t);} if(j.error) throw new Error(j.error); return j; }
    async function jpost(o){ const r=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(o)}); const t=await r.text(); let j; try{ j=JSON.parse(t);}catch{throw new Error('Bad JSON: '+t);} if(j.error) throw new Error(j.error); return j; }

    async function ensureSignIn(){
      await Auth.initGoogle();
      IDT = Auth.peekIdToken();
      if (!IDT) IDT = await Auth.getIdToken(false);
    }

    function formatDateTime(d){ if(!d) return ''; try{ return new Date(d).toLocaleString(); }catch{return d;} }

    function renderList(filter=''){
      const list = $('#list');
      list.innerHTML='';
      const q = filter.trim().toLowerCase();
      let rows = CACHE.pending.slice();
      if (q){
        rows = rows.filter(r =>
          (r.board_name||'').toLowerCase().includes(q) ||
          (r.meeting_title||'').toLowerCase().includes(q) ||
          (r.submitted_by||'').toLowerCase().includes(q) ||
          (r.type||'').toLowerCase().includes(q)
        );
      }
      if (!rows.length){ list.innerHTML='<div class="muted" style="padding:14px">No action items.</div>'; return; }

      for (const r of rows){
        const m = CACHE.meetingsById[r.meeting_id] || {};
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `
          <div><input type="checkbox" class="pick" value="${r.row_id}"></div>
          <div>
            <div class="who">${r.board_name || '(Board)'} <span class="badge">${(r.type||'').toUpperCase()}</span></div>
            <div class="meta">${r.meeting_title||'Meeting'} • ${m.date||r.meeting_date||''} ${m.start_time||''}</div>
          </div>
          <div class="meta">${r.submitted_by||''}</div>
          <div class="meta">${formatDateTime(r.submitted_at)||''}</div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" data-act="view" data-mid="${r.meeting_id}">View agenda items</button>
            <button class="btn btn-ghost" data-act="edit" data-mid="${r.meeting_id}">Quick edit</button>
          </div>`;
        list.appendChild(row);
      }

      // wire actions
      $$('#list [data-act="view"]').forEach(b=>b.onclick=()=>showAgenda(b.dataset.mid));
      $$('#list [data-act="edit"]').forEach(b=>b.onclick=()=>openEditor(b.dataset.mid));
    }

    async function loadData(){
      const [pending, meetings] = await Promise.all([
        jpost({action:'admin_pending', id_token:IDT}),
        jget(`${WEBAPP_URL}?route=api/public/meetings&limit=500`)
      ]);
      // sort newest first by submitted_at (fallback: meeting_date)
      pending.sort((a,b)=>{
        const ad = a.submitted_at || a.meeting_date || '';
        const bd = b.submitted_at || b.meeting_date || '';
        return ad>bd ? -1 : ad<bd ? 1 : 0;
      });
      const map={}; meetings.forEach(m=>map[m.meeting_id]=m);
      CACHE.pending = pending;
      CACHE.meetingsById = map;
      renderList($('#search').value||'');
      $('#count').textContent = String(pending.length);
    }

    async function showAgenda(meeting_id){
      try{
        const data = await jpost({action:'admin_get_agenda_json', id_token:IDT, meeting_id});
        const box=$('#agendaItems'); box.innerHTML='';
        $('#dlgTitle').textContent='Agenda items';
        if (!data.items || !data.items.length){
          box.innerHTML = '<div class="muted">No items captured from builder for this meeting.</div>';
        } else {
          data.items.forEach((it,i)=>{
            const div=document.createElement('div'); div.className='item';
            div.innerHTML=`<div style="font-weight:700">${i+1}. ${it.title||'Item'}</div><div class="muted">${it.notes||''}</div>`;
            box.appendChild(div);
          });
        }
        $('#agendaMeta').textContent = (data.footer_note||'') + (data.remote && (data.remote.url||data.remote.phone) ? ' • Remote info provided' : '');
        $('#dlg').showModal();
      }catch(e){ console.error(e); alert('Could not load agenda JSON: '+e.message); }
    }
    $('#closeDlg')?.addEventListener('click', ()=>$('#dlg').close());

    function openEditor(meeting_id){ location.href = `./admin_edit.html?id=${encodeURIComponent(meeting_id)}`; }

    async function approveSelected(){
      const picks = $$('#list .pick:checked').map(cb=>cb.value);
      if (!picks.length){ alert('Select at least one item.'); return; }
      try{
        await jpost({action:'admin_approve_batch', id_token:IDT, row_ids:picks});
        await loadData();
        alert('Approved '+picks.length+' item(s).');
      }catch(e){ alert('Batch approve failed: '+e.message); }
    }

    (async function(){
      await mountTopnav();
      await ensureSignIn();

      $('#search').addEventListener('input', ()=>renderList($('#search').value));
      $('#approveSel').onclick = approveSelected;

      await loadData();
    })().catch(e=>{ console.error(e); alert('Sign-in required for Clerk/Admin.'); });
  </script>
</head>
<body>
  <div id="topnav"></div>

  <div class="wrap">
    <h2>Clerk Inbox</h2>
    <div class="toolbar">
      <div class="search">
        <input id="search" placeholder="Search by board, title, submitter, or type…">
      </div>
      <button class="btn" id="approveSel">Approve selected</button>
      <span class="muted">Items: <strong id="count">0</strong></span>
    </div>

    <div class="inbox" id="list"></div>
  </div>

  <dialog id="dlg">
    <div class="dlg-head"><strong id="dlgTitle">Agenda items</strong> <button id="closeDlg" class="btn" style="float:right">Close</button></div>
    <div class="dlg-body">
      <div id="agendaItems"></div>
      <div id="agendaMeta" class="muted" style="margin-top:8px"></div>
    </div>
  </dialog>
</body>
</html>
