<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div class="wrap">
  <header style="display:flex;justify-content:space-between;align-items:center">
    <h1>Admin</h1>
    <div id="signin"></div>
  </header>

  <div id="app" style="display:none">
    <div id="list"></div>
  </div>
</div>

<script type="module">
  import { renderSignIn, postSecure, WEBAPP_URL } from './js/auth.js';

  const app = document.getElementById('app');
  renderSignIn('signin', async ()=>{ app.style.display='block'; await build(); });

  async function j(u){ const r=await fetch(u); return r.json(); }

  async function build(){
    const meetings = await j(`${WEBAPP_URL}?route=api/public/meetings&limit=50`);
    const pending = await postSecure('admin_pending', {});
    const pendingByMid = pending.reduce((m,x)=>{ (m[x.meeting_id]=m[x.meeting_id]||[]).push(x); return m; }, {});
    const root = document.getElementById('list'); root.innerHTML='';

    // For quick badge: whether approved agenda exists
    async function hasAgenda(mid){
      const fs = await j(`${WEBAPP_URL}?route=api/public/files&meeting_id=${encodeURIComponent(mid)}`);
      return fs.some(x=>x.type==='agenda');
    }

    for (const m of meetings){
      // pull agenda presence (sequential to keep simple)
      const agenda = await hasAgenda(m.meeting_id);
      const pend   = pendingByMid[m.meeting_id] || [];
      const card = document.createElement('div'); card.className='card';
      const badges = [];
      if (!agenda) badges.push('<span class="badge">Needs agenda</span>');
      if (pend.length) badges.push(`<span class="badge">${pend.length} pending</span>`);
      if (m.status==='awaiting-approval') badges.push('<span class="badge">Awaiting approval</span>');
      if (m.status==='posted') badges.push('<span class="badge">Posted</span>');

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
          <div>
            <div class="muted">${m.board_name||''}</div>
            <div style="font-size:18px;margin:4px 0"><strong>${m.date}</strong> — ${m.title||''}</div>
            <div class="muted">${m.location||''}</div>
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${badges.join('')}</div>
          </div>
          <div>
            <a class="btn" href="./admin_edit.html?id=${encodeURIComponent(m.meeting_id)}">Edit</a>
          </div>
        </div>`;
      root.appendChild(card);
    }
  }
</script>
</body>
</html>
