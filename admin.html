<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div class="wrap">
  <header style="display:flex;justify-content:space-between;align-items:center">
    <h1>Admin</h1>
    <div id="signin"></div>
  </header>

  <div id="app" style="display:none">
    <div id="list"></div>
  </div>
</div>

<script type="module">
  import { renderSignIn, postSecure, WEBAPP_URL, getToken, promptSignIn } from './js/auth.js';

  const app = document.getElementById('app');
  const list = document.getElementById('list');

  renderSignIn('signin', async ()=>{
    app.style.display='block';
    try { await build(); }
    catch (e) { list.innerHTML = `<div class="card" style="border-color:#f66"><b>Error:</b> ${e.message}</div>`; }
  });

  // If the GIS script loads after our code, retry once when DOM is ready and token exists
  if (getToken()) {
    app.style.display='block';
    // defer build slightly to allow GIS to initialize
    setTimeout(async ()=>{ try { await build(); } catch(e){ list.innerHTML = `<div class="card" style="border-color:#f66"><b>Error:</b> ${e.message}</div>`; } }, 50);
  }

  async function j(u){ const r=await fetch(u); if(!r.ok) throw new Error('Failed to load: '+r.status); return r.json(); }

  async function build(){
    list.innerHTML = '<div class="card">Loading…</div>';

    const meetings = await j(`${WEBAPP_URL}?route=api/public/meetings&limit=50`);

    // Try to load pending queue with auth
    let pending = [];
    try { pending = await postSecure('admin_pending', {}); }
    catch (e) {
      // Session probably expired. Ask user to sign in again but still render meetings.
      promptSignIn();
      list.innerHTML = `<div class="card" style="border-color:#f66"><b>Sign-in needed:</b> ${e.message}</div>`;
    }
    const pendingByMid = pending.reduce((m,x)=>{ (m[x.meeting_id]=m[x.meeting_id]||[]).push(x); return m; }, {});

    // Render meetings
    for (const m of meetings){
      let agenda = false;
      try {
        const fs = await j(`${WEBAPP_URL}?route=api/public/files&meeting_id=${encodeURIComponent(m.meeting_id)}`);
        agenda = fs.some(x=>x.type==='agenda');
      } catch {/* ignore */}

      const pend = pendingByMid[m.meeting_id] || [];
      const badges = [];
      if (!agenda) badges.push('<span class="badge">Needs agenda</span>');
      if (pend.length) badges.push(`<span class="badge">${pend.length} pending</span>`);
      if (m.status==='awaiting-approval') badges.push('<span class="badge">Awaiting approval</span>');
      if (m.status==='posted') badges.push('<span class="badge">Posted</span>');

      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
          <div>
            <div class="muted">${m.board_name||''}</div>
            <div style="font-size:18px;margin:4px 0"><strong>${m.date}</strong> — ${m.title||''}</div>
            <div class="muted">${m.location||''}</div>
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${badges.join('')}</div>
          </div>
          <div>
            <a class="btn" href="./admin_edit.html?id=${encodeURIComponent(m.meeting_id)}">Edit</a>
          </div>
        </div>`;
      // First real card clears "Loading…"
      if (list.firstChild && list.firstChild.textContent?.includes('Loading…')) list.innerHTML = '';
      list.appendChild(card);
    }

    if (!meetings.length) {
      list.innerHTML = '<div class="card">No meetings to display.</div>';
    }
  }
</script>
</body>
</html>
