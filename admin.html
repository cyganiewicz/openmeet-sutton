<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
  <style>
    .toolbar{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi{padding:12px;border-radius:12px;background:#0f172a;color:#fff}
    .row{background:#0b1020;color:#e5e7eb;border-radius:12px;padding:12px;display:grid;grid-template-columns:180px 1fr 320px;gap:12px;align-items:center}
    .pill{padding:4px 8px;border-radius:999px;background:#1f2937;color:#ddd;font-size:12px}
    .btn-ghost{background:transparent;border:1px solid #334155}
    dialog{max-width:720px;width:96%;border:0;border-radius:12px;padding:0;overflow:hidden}
    .dlg-head{background:#0f172a;color:#fff;padding:12px 16px}
    .dlg-body{padding:16px}
    .item{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;margin:6px 0}
    .muted{opacity:.8}
  </style>
  <script type="module">
    // Cache-bust auth.js to avoid stale exports on GitHub Pages
    const v = '3.0.0'; // must match AUTH_JS_VERSION
    import * as Auth from './js/auth.js?v=3.0.0';

    const $ = (s, r=document)=>r.querySelector(s);
    const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));

    // Defensive: verify the named exports exist
    if (!Auth || typeof Auth.getIdToken!=='function' || typeof Auth.initGoogle!=='function'){
      console.error('auth.js exports missing. Fallback to window.OpenMeetAuth…');
    }

    const WEBAPP_URL = (Auth.WEBAPP_URL || (window.OpenMeetAuth && window.OpenMeetAuth.WEBAPP_URL));
    let IDT = null;

    async function jget(u){ const r=await fetch(u); const t=await r.text(); let j; try{ j=JSON.parse(t); }catch{ throw new Error('Bad JSON: '+t); } if(j.error) throw new Error(j.error); return j; }
    async function jpost(o){ const r=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(o)}); const t=await r.text(); let j; try{ j=JSON.parse(t); }catch{ throw new Error('Bad JSON: '+t); } if(j.error) throw new Error(j.error); return j; }

    function dedupeBy(arr, key){ const seen=new Set(), out=[]; for(const x of arr){ const k=x[key]; if(!seen.has(k)){ seen.add(k); out.push(x); } } return out; }

    async function requireSignIn(){
      try{
        if (Auth && Auth.initGoogle) await Auth.initGoogle(); else if (window.OpenMeetAuth) await window.OpenMeetAuth.initGoogle();
        const fn = (Auth && Auth.getIdToken) ? Auth.getIdToken : (window.OpenMeetAuth && window.OpenMeetAuth.getIdToken);
        if (!fn) throw new Error('getIdToken missing');
        IDT = await fn(true); // force prompt first time
        $('#who').textContent = 'Signed in';
      }catch(e){
        console.error(e);
        $('#who').textContent = 'Sign-in required';
        throw e;
      }
    }

    async function loadQueue(){
      const pending = await jpost({action:'admin_pending', id_token:IDT});
      const upcoming = await jget(`${WEBAPP_URL}?route=api/public/meetings&limit=200`);
      const byId = {}; dedupeBy(upcoming,'meeting_id').forEach(m => byId[m.meeting_id]=m);

      $('#kpiPending').textContent = String(pending.length);
      $('#kpiMeetings').textContent = String(Object.keys(byId).length);

      const list = $('#rows'); list.innerHTML='';
      const queueByMeeting = {};
      pending.forEach(p => { (queueByMeeting[p.meeting_id] ||= []).push(p); });

      for (const [mid, items] of Object.entries(queueByMeeting)){
        const m = byId[mid] || {title:'(Draft)', date:'', board_name:'', status:'awaiting-approval'};
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `
          <div>
            <div style="font-weight:700">${m.board_name||'(Board)'} </div>
            <div class="muted">${m.date||''} ${m.start_time||''}</div>
          </div>
          <div>
            <div style="font-weight:600">${m.title||'Meeting'}</div>
            <div class="muted">${m.location||''}</div>
            <div style="margin-top:6px">${items.map(it=>`<span class="pill">${it.type.toUpperCase()}</span>`).join(' ')}</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" data-act="view" data-mid="${mid}">View agenda items</button>
            <button class="btn" data-act="approve" data-mid="${mid}">Approve agenda</button>
            <a class="btn btn-ghost" target="_blank" href="https://drive.google.com/drive/folders/${m.public_folder_id||''}">Open Public</a>
            <a class="btn btn-ghost" target="_blank" href="https://drive.google.com/drive/folders/${m.draft_folder_id||''}">Open Drafts</a>
            <button class="btn btn-ghost" data-act="edit" data-mid="${mid}">Quick edit</button>
          </div>`;
        list.appendChild(row);
      }
      if (!list.children.length){
        const e = document.createElement('div');
        e.className='muted'; e.textContent='No items awaiting approval.';
        list.appendChild(e);
      }
      $$('#rows [data-act="approve"]').forEach(b=>b.onclick=()=>approveAgenda(b.dataset.mid));
      $$('#rows [data-act="view"]').forEach(b=>b.onclick=()=>showAgenda(b.dataset.mid));
      $$('#rows [data-act="edit"]').forEach(b=>b.onclick=()=>openEditor(b.dataset.mid));
    }

    async function showAgenda(meeting_id){
      const data = await jpost({action:'admin_get_agenda_json', id_token:IDT, meeting_id});
      $('#dlgTitle').textContent = 'Agenda items ('+meeting_id+')';
      const box = $('#agendaItems'); box.innerHTML='';
      if (!data.items || !data.items.length){ box.innerHTML='<div class="muted">No items captured from builder.</div>'; }
      else data.items.forEach((it, i)=>{
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<div style="font-weight:700">${i+1}. ${it.title||'Item'}</div><div class="muted">${it.notes||''}</div>`;
        box.appendChild(div);
      });
      $('#agendaMeta').textContent = (data.footer_note||'') + (data.remote && (data.remote.url||data.remote.phone) ? ' • Remote info provided' : '');
      $('#dlg').showModal();
    }
    $('#closeDlg')?.addEventListener('click', ()=>$('#dlg').close());

    async function approveAgenda(meeting_id){
      const pending = await jpost({action:'admin_pending', id_token:IDT});
      const row = pending.find(x=>x.meeting_id===meeting_id && x.type==='agenda');
      if (!row){ alert('No agenda awaiting approval for this meeting.'); return; }
      const res = await jpost({action:'admin_approve', id_token:IDT, row_id: row.row_id});
      alert('Agenda approved & published.\n\n'+(res.publicLink||''));
      await loadQueue();
    }
    function openEditor(meeting_id){ location.href = `./admin_edit.html?id=${encodeURIComponent(meeting_id)}`; }

    (async function(){
      await requireSignIn();
      await loadQueue();
    })().catch(e=>{ console.error(e); alert('Sign-in required for Clerk/Admin.'); });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <h2>Clerk Console</h2>
      <div id="who" class="muted">Loading sign-in…</div>
    </div>

    <div class="kpis" style="margin:12px 0 16px">
      <div class="kpi"><div class="muted">Awaiting approval</div><div id="kpiPending" style="font-size:28px;font-weight:800">0</div></div>
      <div class="kpi"><div class="muted">Meetings indexed</div><div id="kpiMeetings" style="font-size:28px;font-weight:800">0</div></div>
      <div class="kpi"><div class="muted">Today</div><div style="font-size:28px;font-weight:800"><script>document.write(new Date().toLocaleDateString())</script></div></div>
      <div class="kpi"><div class="muted">Domain</div><div style="font-size:28px;font-weight:800">town.sutton.ma.us</div></div>
    </div>

    <h3>Action Queue</h3>
    <div id="rows"></div>
  </div>

  <dialog id="dlg">
    <div class="dlg-head"><strong id="dlgTitle">Agenda items</strong> <button id="closeDlg" class="btn" style="float:right">Close</button></div>
    <div class="dlg-body">
      <div id="agendaItems"></div>
      <div id="agendaMeta" class="muted" style="margin-top:8px"></div>
    </div>
  </dialog>
</body>
</html>
