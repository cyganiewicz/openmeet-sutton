<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Your Meetings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
  <style>
    .card{margin-bottom:12px}
    .file{border:1px dashed #334155;border-radius:10px;padding:12px}
  </style>
  <script type="module">
    import { WEBAPP_URL, initGoogle, getIdToken } from './js/auth.js';
    const $=s=>document.querySelector(s);

    async function jpost(o){ const r=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(o)}); const t=await r.text(); let j; try{j=JSON.parse(t);}catch{throw new Error('Bad JSON: '+t);} if(j.error) throw new Error(j.error); return j; }

    let IDT=null;
    async function boot(){
      await initGoogle();
      IDT = await getIdToken(true);
      $('#who').textContent='Signed in';

      const mine = await jpost({action:'my_meetings_secure', id_token:IDT});
      const list = $('#list'); list.innerHTML='';
      if (!mine.length){ list.innerHTML='<div class="muted">No meetings yet.</div>'; return; }

      mine.forEach(m=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${m.title||'Meeting'}</strong><div class="muted">${m.date||''} • ${m.location||''} • ${m.status||''}</div></div>
            <a class="btn" href="./meeting.html?id=${m.meeting_id}">View public page</a>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <label class="file">Upload Packet PDF <input type="file" data-type="packet" data-mid="${m.meeting_id}" accept="application/pdf" style="display:block;margin-top:6px"></label>
            <label class="file">Upload Exhibit <input type="file" data-type="exhibit" data-mid="${m.meeting_id}" style="display:block;margin-top:6px"></label>
          </div>`;
        list.appendChild(el);
      });

      list.addEventListener('change', async e=>{
        const inp = e.target;
        if (inp.type!=='file' || !inp.files[0]) return;
        const type = inp.dataset.type;
        const meeting_id = inp.dataset.mid;
        const file = inp.files[0];
        const b64 = await file.arrayBuffer().then(b=>btoa(String.fromCharCode(...new Uint8Array(b))));
        try{
          await jpost({action:'submit_file_open', meeting_id, type, file_b64:b64, fileName:file.name, mimeType:file.type, submitterEmail:'self'});
          alert((type==='packet'?'Packet':'Exhibit')+' uploaded.');
        }catch(err){ alert(err.message); }
      });
    }
    boot().catch(e=>{ console.error(e); alert('Sign-in required'); });
  </script>
</head>
<body>
  <div class="wrap">
    <h2>Your Meetings</h2>
    <div id="who" class="muted">Loading sign-in…</div>
    <div id="list" style="margin-top:12px"></div>
  </div>
</body>
</html>
