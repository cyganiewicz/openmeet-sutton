<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Create Meeting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;margin-bottom:16px}
    .row{display:grid;grid-template-columns:180px 1fr;gap:12px;margin:8px 0}
    .muted{opacity:.8}
    .items .it{display:grid;grid-template-columns:1fr auto auto;gap:8px;margin:6px 0}
    .btn-ghost{background:transparent;border:1px solid #cbd5e1}
    input, select, textarea{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#f8fafc}
  </style>
  <script type="module">
    import * as Auth from './js/auth.js?v=3.0.2';
    import { mountTopnav } from './js/topnav.js?v=4';

    const $ = s=>document.querySelector(s);
    const WEBAPP_URL = Auth.WEBAPP_URL;

    async function jget(u){ const r=await fetch(u); const t=await r.text(); let j; try{ j=JSON.parse(t);}catch{throw new Error('Bad JSON: '+t);} if(j.error) throw new Error(j.error); return j; }
    async function jpost(o){ const r=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(o)}); const t=await r.text(); let j; try{ j=JSON.parse(t);}catch{throw new Error('Bad JSON: '+t);} if(j.error) throw new Error(j.error); return j; }

    function addItemRow(title='', notes=''){
      const box = $('#items');
      const div = document.createElement('div'); div.className='it';
      div.innerHTML = `
        <input placeholder="Agenda item title" value="${title.replace(/"/g,'&quot;')}">
        <button class="btn btn-ghost" data-act="up" title="Move up">↑</button>
        <button class="btn btn-ghost" data-act="del" title="Remove">✕</button>
        <textarea placeholder="Notes (optional)" style="grid-column:1/-1;margin-top:6px">${notes||''}</textarea>
      `;
      box.appendChild(div);
    }

    // Require sign-in before enabling Create
    async function ensureSignedIn(){
      await Auth.initGoogle();
      const token = Auth.peekIdToken() || await Auth.getIdToken(false);
      const email = (()=>{ try{ return JSON.parse(atob(token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))).email || ''; }catch{return '';} })();
      $('#who').textContent = email ? email : '(unknown)';
      $('#create').disabled = !email;
      return email;
    }

    (async function(){
      await mountTopnav();

      // Load boards
      const boards = await jget(`${WEBAPP_URL}?route=api/ui/boards`);
      const sel = $('#board'); sel.innerHTML = '<option value="">Select a board/committee…</option>';
      boards.forEach(b => { const o=document.createElement('option'); o.value=b.board_id; o.textContent=b.name; sel.appendChild(o); });

      // Agenda builder basics
      $('#addItem').onclick = ()=>addItemRow();
      $('#items').addEventListener('click', e=>{
        const btn=e.target.closest('button'); if(!btn) return;
        const row=btn.closest('.it'); if(!row) return;
        if (btn.dataset.act==='del'){ row.remove(); }
        if (btn.dataset.act==='up'){ const prev=row.previousElementSibling; if(prev) row.parentNode.insertBefore(row, prev); }
      });
      addItemRow('Call to Order','');

      const email = await ensureSignedIn();

      $('#create').onclick = async ()=>{
        const board_id = $('#board').value;
        const title    = $('#title').value.trim() || 'Regular Meeting';
        const date     = $('#date').value;
        const start    = $('#time').value;
        const location = $('#location').value.trim();
        if (!board_id || !date){ alert('Please select a board and date.'); return; }

        // 1) Create meeting shell (submitterEmail is required so "My Meetings" sees it)
        const created = await jpost({action:'create_meeting_open', board_id, title, date, start_time:start, location, submitterEmail: email});
        const meeting_id = created.meeting_id;

        // 2) Agenda JSON (optional)
        const items = Array.from(document.querySelectorAll('#items .it')).map(div=>{
          const [inpTitle, btnUp, btnDel, ta] = div.children;
          return {title: inpTitle.value.trim(), notes: (ta.value||'').trim()};
        }).filter(x=>x.title);

        const footerNote = $('#footer').value.trim();
        const remote = {
          url: $('#remote_url').value.trim(),
          phone: $('#remote_phone').value.trim(),
          id: $('#remote_id').value.trim(),
          pass: $('#remote_pass').value.trim()
        };

        if (items.length){
          await jpost({action:'create_agenda_from_form', meeting_id, items, footerNote, remote, submitterEmail: email});
          alert('Meeting created and agenda sent to Clerk for approval.');
        } else {
          alert('Meeting created. You can add materials later via “Your Meetings”.');
        }
        location.href = `./meeting.html?id=${encodeURIComponent(meeting_id)}`;
      };
    })().catch(e=>{ console.error(e); alert(e.message); });
  </script>
</head>
<body>
  <div id="topnav"></div>

  <div class="wrap">
    <h2>Create a Meeting</h2>
    <p class="muted">Signed in as <span class="chip" id="who">checking…</span></p>

    <div class="card">
      <div class="row"><label>Board/Committee</label><select id="board"></select></div>
      <div class="row"><label>Meeting title</label><input id="title" placeholder="e.g., Regular Meeting"></div>
      <div class="row"><label>Date</label><input id="date" type="date"></div>
      <div class="row"><label>Start time</label><input id="time" type="time"></div>
      <div class="row"><label>Location</label><input id="location" placeholder="Town Hall, 3rd Floor, Room 310"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Agenda (optional)</h3>
      <p class="muted">Outline your agenda. The Clerk will receive it for posting/approval.</p>
      <div id="items" class="items"></div>
      <button class="btn btn-ghost" id="addItem" style="margin-top:8px">Add item</button>

      <h4 style="margin-top:16px">Footer note</h4>
      <textarea id="footer" placeholder="Standard notice and any additional information"></textarea>

      <h4 style="margin-top:16px">Remote access (optional)</h4>
      <div class="row"><label>Join URL</label><input id="remote_url" placeholder="https://meet.google.com/…"></div>
      <div class="row"><label>Phone</label><input id="remote_phone" placeholder="(###) ###-####"></div>
      <div class="row"><label>Meeting ID</label><input id="remote_id"></div>
      <div class="row"><label>Passcode</label><input id="remote_pass"></div>
    </div>

    <div style="display:flex;gap:12px">
      <button class="btn" id="create" disabled>Create meeting</button>
      <a class="btn btn-ghost" href="./my.html">Revise my meetings</a>
    </div>
  </div>
</body>
</html>
