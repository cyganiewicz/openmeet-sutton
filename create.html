<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OpenMeet – Create Meeting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./assets/theme.css">
</head>
<body>
<div class="wrap">
  <a class="btn" href="./">← Back</a>
  <h2>Create a New Meeting</h2>

  <div class="card">
    <h3>1) Choose Board / Committee</h3>
    <select id="board"></select>
  </div>

  <div class="card">
    <h3>2) Meeting Details</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div><label>Date (YYYY-MM-DD)</label><input id="mDate" placeholder="2025-10-20"></div>
      <div><label>Start Time (HH:MM)</label><input id="mTime" placeholder="19:00"></div>
    </div>
    <label>Title</label><input id="mTitle" placeholder="Regular Meeting">
    <label>Location</label><input id="mLoc" placeholder="Town Hall">
    <label>Your email (for confirmations)</label><input id="email" placeholder="you@example.com">
    <button class="btn" id="btnCreate">Create meeting</button>
    <div id="mOut" class="card" style="margin-top:8px;display:none"></div>
  </div>
</div>

<script type="module">
  import { WEBAPP_URL } from './js/auth.js';

  async function j(u){
    const r = await fetch(u);
    if (!r.ok) throw new Error('Failed to load: ' + r.status);
    return r.json();
  }
  async function post(bodyObj){
    const r = await fetch(WEBAPP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // avoid preflight
      body: JSON.stringify(bodyObj),
    });
    const text = await r.text();
    let out;
    try { out = JSON.parse(text); } catch { throw new Error('Bad JSON from server: ' + text.slice(0,200)); }
    if (out.error) throw new Error(out.error);
    return out;
  }

  // Load boards with defensive messaging
  const sel = document.getElementById('board');
  try {
    const boards = await j(`${WEBAPP_URL}?route=api/ui/boards`);
    sel.innerHTML = (boards && boards.length)
      ? '<option value="">Select a board/committee…</option>' + boards.map(b=>`<option value="${b.board_id}">${b.name}</option>`).join('')
      : '<option value="">No boards found — check the Boards sheet (header must be "is_active")</option>';
  } catch (e) {
    sel.innerHTML = '<option value="">Could not load boards (check WEBAPP_URL)</option>';
  }

  const mOut = document.getElementById('mOut');
  document.getElementById('btnCreate').onclick = async ()=>{
    const board_id=sel.value, date=mDate.value.trim(), title=mTitle.value.trim()||'Regular', loc=mLoc.value.trim(), time=mTime.value.trim(), email=document.getElementById('email').value.trim();
    if(!board_id) return alert('Choose a board');
    if(!date) return alert('Enter a date');
    try{
      const res = await post({action:'create_meeting_open', board_id, date, title, location:loc, start_time:time, submitterEmail:email});
      mOut.style.display='block';
      mOut.textContent = 'Created meeting: '+res.meeting_id+' (check your email for confirmation)';
      alert('Meeting created');
    }catch(e){ alert(e.message); }
  };
</script>
</body>
</html>
